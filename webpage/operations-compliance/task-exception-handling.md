# 出图/训练任务异常处理流程（草稿）

## 目标
- 统一出图、训练任务在执行异常时的识别、处置和用户沟通流程。
- 保障积分退还、任务状态回写、人工介入判定的一致性。

## 适用情景
- 出图任务运行失败、耗时异常、排队超时。
- 训练任务过程中 GPU 崩溃、数据损坏、配额不足、用户主动中断。
- 平台监控触发风险告警，需要暂停或回滚任务。

## 流程概览
1. **异常检测**：由监控系统、用户反馈或人工巡检发现。
2. **状态冻结**：调用 `platform-integration` 提供的暂停接口，阻断后续扣费或资源占用。
3. **分类判定**：依据异常类型划分为可重试、需人工处理、需退款三类。
4. **执行处置**：按分类流程执行自动化或人工操作。
5. **用户通知**：通过站内信/邮件/短信同步处理进度与结果。
6. **记录与复盘**：在工单系统记录详情，必要时加入风控看板进行复盘。

## 异常分类与处置
### 1. 可自动重试
- 场景：临时网络抖动、节点重启后可恢复。
- 处理：系统自动重试（默认 1 次），成功后恢复正常扣费；失败则转入“需人工处理”。
- 通知：任务页面提示“正在自动重试”，并记录在日志中。

### 2. 需人工处理
- 场景：素材缺失、元数据格式错误、权限校验失败、GPU 资源不足等。
- 处理步骤：
  1. 生成工单并指派审核员/平台工程师；
  2. 根据接口返回的错误码定位原因；
  3. 给出解决方案（补资料、调整配额、修复脚本），修复后人工恢复任务或通知用户重新提交。
- 积分：暂停扣费，待任务恢复后再扣；若 24 小时未恢复需全额退款。
- 通知：发送待办提醒，明确需要用户或内部团队的行动项及 SLA。

### 3. 需退款/终止
- 场景：多次失败仍无法恢复、涉嫌违规被拦截、用户取消、系统级故障。
- 处理步骤：
  1. 调用退款接口，按消耗进度退还积分（训练任务可按剩余时间计算比例）；
  2. 更新任务状态为“已取消”或“失败”；
  3. 若涉及违规，同步给运营合规团队，触发模板下架或账号处罚流程。
- 通知：明确说明退款金额、到账时间、是否允许重试。

## 辅助要求
- `platform-integration` 需提供：暂停/恢复、取消、部分退款、错误码字典、任务日志查询接口。
- `shared` 跟踪接口变更并更新到共享文档；`product-planning` 参与确认补偿规则。
- 前端需在任务中心展示实时状态、处理中提示、退款结果。

## 指标与复盘
- 关键指标：任务失败率、平均恢复时长、人工介入比例、退款金额、重复失败模板 ID。
- 定期复盘高频异常原因，输出优化建议（脚本容错、素材校验、资源扩容等）。

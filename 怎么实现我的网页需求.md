 # 女娲造人 AI 平台 — 网页实现技术方案（可落地版）

 更新时间：2025-09-15

 本文将《需求文档》的业务规则转为可实施的技术与产品方案，覆盖：系统架构、关键数据模型、核心流程、接口草案、合规与风控、签名下载、安全与权限，以及分阶段里程碑与验收清单。用于指导从 0 到 1 的落地实施与团队协作。

 ## 一、目标与范围
 - 平台定位：仅售“显卡算力（积分）”，模板与教程费在私域收款；站内仅做授权校验与留痕。
 - 核心能力：模板授权 → 参数化出图 → 计费（预估/冻结/结算）→ 结果签名下载 → 留痕审计。
 - 合规边界：内置前置拦截、分级策略、留痕与申诉机制；严格的下载与导出边界（模型不可导出）。
 - MVP 范围（8–10 周可交付）：
   - 用户体系与钱包积分、充值记录
   - 模板广场、模板详情与“一键复刻 DEMO”
   - 授权校验（站内使用权）、任务预估/冻结/结算
   - 生成任务队列（普通/快速）、失败与退款规则
   - 结果签名下载（短时 URL）、历史与账单明细
   - 基础合规（关键词拦截、NSFW 粗分级、留痕）

 ## 二、系统架构（推荐）
 - 前端：Next.js 14（App Router）+ TypeScript + Tailwind CSS
   - 页面：首屏（价值主张与案例）、模板广场、模板详情（授权指引）、任务面板、钱包、历史、后台（审核/风控）。
 - 后端：Node.js（NestJS 或 Next API 路由）+ TypeScript
   - ORM：Prisma + PostgreSQL（强一致、便于审计）
   - 队列：Redis + BullMQ（普通/快速队列，权重与并发可调）
   - 存储：S3 兼容（MinIO/OSS/COS 皆可），对象均走短时签名 URL 下发
   - 日志与观测：OpenTelemetry + Prometheus/Grafana（或 Log 服务）
 - 推理执行：两种落地路径（二选一，MVP 先选 A，B 为演进）
   - A. 外部推理 Provider 适配层（Replicate/Comfy-API/自建 Inference-API）
     - 快速上线，统一计费口径映射到“积分”。
   - B. 自建 GPU Worker（Python + FastAPI + Diffusers/ComfyUI Headless）
     - Worker 从队列取任务，按模板/LoRA 组合加载模型，回传产物与计时数据。
 - 合规：Prompt/参数前置检查、内容 NSFW/涉政模型粗分级、人工复核队列。
 - 授权：License 服务（账号维度授权/限期/限次），任务提交时强校验与留痕。

 ## 三、数据模型（PostgreSQL 草案）
 - users（用户）
   - id, login_id(手机号/微信OpenId), role[user,creator,admin,moderator], status, created_at
 - wallets（钱包）
   - id, user_id, balance(可用), frozen(冻结), updated_at
 - transactions（流水）
   - id, user_id, type[recharge,hold,settle,refund,adjust], amount, status, ref_type, ref_id, created_at
 - templates（模板）
   - id, creator_id, title, summary, tags(jsonb), params_schema(jsonb), lora_refs(jsonb), visibility, status, demo_job_id, created_at
 - licenses（授权）
   - id, template_id, user_id, status[active,revoked,expired], limit_count, used_count, expire_at, created_at
 - jobs（任务）
   - id, user_id, template_id, queue[normal,fast], status[pending,queued,running,succeeded,failed,canceled],
   - params(jsonb), estimate_cost, hold_txn_id, final_cost,
   - started_at, finished_at, created_at, failure_reason
 - artifacts（产物）
   - id, job_id, kind[image,log,json], s3_key, sha256, bytes, expires_at, created_at
 - audits（操作留痕）
   - id, actor_id, action, subject_type, subject_id, data(jsonb), created_at
 - compliance_logs（合规）
   - id, owner_type[job,template], owner_id, rule_id, severity, passed, details, created_at

 计费口径映射：
 - 训练类（后续）：基础费 + 按有效图片数 + 队列系数 + 缓冲冻结20%
 - 推理类（当前MVP）：按分辨率与张数取高值 × 队列系数；提交前估价并冻结，完成后按实际结算，多退少补。

 ## 四、核心时序（出图任务）
 1) 模板详情页点击“一键复刻” → 拉起参数面板（预填 DEMO 参数）
 2) 前端调后端 `/billing/estimate` 返回估价与建议冻结额
 3) 用户确认 → `/jobs/create`：
    - 校验余额 ≥ 冻结额 → 创建 hold 交易（冻结）
    - 校验授权：licenses.active 且未超期/超次
    - 合规检查：prompt/参数前置规则 → 不通过直接拒绝
    - 入队（normal/fast）并返回 job_id
 4) Worker 取任务 → 执行推理 → 产物写入 S3 → 回写 artifacts
 5) 结算 `/billing/settle(job_id)`：
    - 根据时长/分辨率/张数/队列等实际数据计算 final_cost
    - 冻结转结算，多退少补；失败/取消按规则退款
 6) 结果页展示缩略图与“签名下载”链接；历史与账单留痕可追溯。

 ## 五、接口草案（选摘）
 - Auth 与账户
   - POST `/auth/login`（短信/测试通道）
   - GET `/me` 用户信息与 KYC 状态
 - 钱包与计费
   - GET `/wallet` 余额与冻结
   - POST `/recharge/create`（生成充值单据，站外支付）
   - POST `/billing/estimate` {templateId,params,queue} → {estimate,hold}
   - POST `/billing/settle` {jobId}（Worker 或任务完成回调触发）
 - 模板
   - GET `/templates`（筛选/分页/热门）
   - GET `/templates/:id`（参数 schema、LoRA 说明、授权指引）
   - POST `/templates`（创作者）
 - 授权
   - GET `/licenses?templateId=` 当前账号授权态
   - POST `/licenses/grant`（创作者/管理员）
   - POST `/licenses/revoke`（违规撤销）
 - 任务
   - POST `/jobs/create`
   - GET `/jobs/:id`（状态/产物缩略信息）
   - POST `/jobs/:id/cancel`
 - 下载（签名）
   - GET `/download?token=...` 校验 HMAC 与过期时间后回源 S3 流式下发

 请求/响应示例（简）：
 - 估价请求：
 ```json
 POST /billing/estimate
 {
   "templateId":"tpl_123",
   "queue":"normal",
   "params":{"resolution":"1024x1024","numImages":4}
 }
 ```
 - 估价响应：
 ```json
 {
   "estimate": 260,
   "hold": 312,
   "formula": "max(perImage,byResolution) * queueCoef",
   "queueCoef": 1.0
 }
 ```

 ## 六、签名下载（短时 URL）
 - 设计：`token = base64(url+expiresAt) + "." + HMAC_SHA256(secret, url|expiresAt|userId)`
 - 链路：前端请求 `/download?key=...` → 服务端验证 token/过期时间/归属 → 生成 S3 短时签名并 302 或直连流式返回。
 - 风险控制：
   - token 绑定 userId 与一次性 nonce（Redis 5 分钟幂等窗口）
   - 有效期 60–300 秒，越权与热链自动失败

 伪代码（Node）：
 ```ts
 function sign(key, userId, ttl=120) {
   const exp = Date.now()+ttl*1000
   const payload = `${key}|${userId}|${exp}`
   const mac = hmacSHA256(SECRET, payload)
   return base64url(`${key}|${userId}|${exp}|${mac}`)
 }
 function verify(token){
   const [key, uid, exp, mac] = parse(base64urlDecode(token))
   if (Date.now()>+exp) throw Expired
   if (hmacSHA256(SECRET, `${key}|${uid}|${exp}`)!==mac) throw Invalid
   // 可选：校验归属与授权
 }
 ```

 ## 七、合规与风控
 - 前置拦截：
   - 关键词与提示词策略（涉政/色情/仇恨/暴力/违法等），命中直接拒绝或二次确认
   - 图像检测（如存在参考图）：NSFW/裸露度阈值、未成年人识别、二维码/水印检测
 - 事后分级：
   - 产物回写后进行 NSFW/涉政复核，命中高危直接下架并记留痕
   - 复核队列（moderator）与快速处置流程（先下架后核查）
 - 留痕与追溯：
   - 记录任务、提示词、参数、授权态、冻结/结算明细、风控命中项与人工操作

 ## 八、安全与权限
 - 模型/LoRA 不可导出：仅 Worker 内部加载与缓存，外部无下载接口
 - 账号授权：账号维度授权与期/次限制，任意时刻可撤销（即刻生效）
 - RBAC：user/creator/admin/moderator 的接口白名单
 - 速率限制：按 IP/账号/模板维度限速与配额

 ## 九、开发里程碑（建议）
 - 里程碑 A（第 1–3 周）
   - 项目脚手架（Next.js + NestJS/Next-API）与基础组件
   - 用户登录/测试通道、钱包/流水、模板 CRUD、授权模型
   - 估价/冻结/结算的领域服务与单元测试
 - 里程碑 B（第 4–6 周）
   - 队列（Redis + BullMQ）与 Worker 适配层（先接入外部推理）
   - 结果存储（S3 兼容）与签名下载
   - 一键复刻 DEMO、任务历史/账单
 - 里程碑 C（第 7–8/10 周）
   - 合规与风控（前置+事后）、复核后台与审计
   - 管理后台（模板审核/违规处置）、监控与告警

 ## 十、验收清单（MVP）
 - 无授权无法提交任务；授权撤销后立刻不可用
 - 预估/冻结/结算全链路可追溯；失败/取消按规则退款
 - 下载仅通过短时签名 URL；越权/过期均失败
 - DEMO 可一键复刻，复现率达标（标注前处理/后处理）
 - 留痕完整：任务、参数、授权、计费、风控命中与人工操作

 ## 十一、部署建议
 - Dev：docker-compose（Postgres/Redis/MinIO）+ 本地服务
 - Prod：三层（公网访问层/API/Worker），对象存储独立；CI/CD 与 IaC（Terraform/Helm）
 - 监控：核心业务指标（任务时延、成功率、估价误差、退款率、留痕完整率）

 ## 十二、演进与备选
 - 推理从外部 Provider 平滑迁移到自建 GPU Worker（不改领域模型）
 - 引入素材训练与创作者转化：上传素材 → 数小时返回专属模型 → 一键发布模板（加权证据）
 - 模板与任务 A/B、分群白名单与风控策略联动

 —— 以上为可落地的实现路径。如果需要，我可以继续为你：
 1) 初始化代码脚手架（Next.js + API + Prisma）
 2) 补充数据库 DDL 与 Prisma schema
 3) 输出 OpenAPI 3 规范与 Postman 集合
 4) 写出“签名下载”与“预估/冻结/结算”的参考实现
